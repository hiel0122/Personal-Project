<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>방문자 출석 관리 앱 (설정 선행)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0f4f8;
            display: flex;
            justify-content: center;
            align-items: flex-start;
            min-height: 100vh;
            padding: 2rem;
            box-sizing: border-box;
        }
        .container {
            background-color: #ffffff;
            padding: 2.5rem;
            border-radius: 1.5rem;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
            width: 100%;
            max-width: 800px; /* 컨테이너 너비 확장 */
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
        }
        input[type="text"], input[type="file"], input[type="date"], button {
            border-radius: 0.75rem;
            padding: 0.75rem 1.25rem;
            font-size: 1rem;
        }
        button {
            background-color: #4f46e5;
            color: white;
            font-weight: 600;
            transition: background-color 0.3s ease;
            box-shadow: 0 4px 10px rgba(79, 70, 229, 0.3);
        }
        button:hover {
            background-color: #4338ca;
        }
        .message-box {
            background-color: #e0f2fe;
            color: #0c4a6e;
            padding: 0.75rem;
            border-radius: 0.75rem;
            margin-top: 1rem;
            font-size: 0.9rem;
            border: 1px solid #90cdf4;
        }
        .visitor-item, .checked-in-item {
            background-color: #f8fafc;
            padding: 1rem;
            border-radius: 0.75rem;
            border: 1px solid #e2e8f0;
            display: flex;
            flex-direction: column; /* 세로 정렬 */
            gap: 0.5rem; /* 항목 간 간격 */
            margin-bottom: 0.75rem;
        }
        .visitor-item.matched {
            background-color: #d1fae5; /* 매칭 완료 시 녹색 */
            border-color: #34d399;
        }
        .visitor-item:last-child, .checked-in-item:last-child {
            margin-bottom: 0;
        }
        .user-id-display { /* 이 클래스는 이제 통합된 정보 표시에 사용됩니다. */
            background-color: #f0f9ff;
            color: #1e40af;
            padding: 0.75rem;
            border-radius: 0.75rem;
            font-size: 0.9rem; /* 폰트 크기 조정 */
            word-break: break-all;
            border: 1px solid #bfdbfe;
            margin-top: 1rem;
        }
        .user-id-display p {
            margin-bottom: 0.4rem; /* 각 줄 간격 */
        }
        .user-id-display p:last-child {
            margin-bottom: 0;
        }

        .count-display {
            display: flex;
            justify-content: space-around;
            background-color: #eef2ff;
            padding: 1rem;
            border-radius: 1rem;
            box-shadow: inset 0 2px 5px rgba(0, 0, 0, 0.05);
            margin-bottom: 1.5rem;
        }
        .count-item {
            text-align: center;
            font-weight: 600;
            color: #4a5568;
        }
        .count-item span {
            display: block;
            font-size: 2.5rem;
            color: #4f46e5;
            line-height: 1;
            margin-bottom: 0.25rem;
        }
        .match-action-btn {
            background-color: #10b981; /* 녹색 */
            margin-top: 0.5rem;
        }
        .match-action-btn:hover {
            background-color: #059669;
        }
        .search-results-title {
            font-size: 1.25rem;
            font-weight: 600;
            color: #4a5568;
            margin-top: 1rem;
            margin-bottom: 1rem;
        }
        .rawdata-section {
            background-color: #f0f9ff;
            padding: 1.5rem;
            border-radius: 1.5rem;
            border: 1px dashed #bfdbfe;
            margin-top: 2rem;
        }
        .csv-input-group {
            display: flex;
            gap: 1rem;
            align-items: center;
        }
        .csv-input-group input[type="file"] {
            flex-grow: 1;
            padding: 0.5rem;
            border: 1px solid #d1d5db;
            border-radius: 0.75rem;
            background-color: #fff;
            cursor: pointer;
        }

        /* Modal specific styles */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease, visibility 0.3s ease;
        }
        .modal-overlay.show {
            opacity: 1;
            visibility: visible;
        }
        .modal-content {
            background-color: white;
            padding: 2rem;
            border-radius: 1rem;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
            text-align: center;
            max-width: 400px;
            width: 90%;
            transform: translateY(-20px);
            transition: transform 0.3s ease;
        }
        .modal-overlay.show .modal-content {
            transform: translateY(0);
        }
        .modal-title {
            font-size: 1.5rem;
            font-weight: 700;
            color: #ef4444; /* Red for warning */
            margin-bottom: 1rem;
        }
        .modal-message {
            font-size: 1.1rem;
            color: #374151;
            margin-bottom: 1.5rem;
        }
        .modal-close-btn {
            background-color: #ef4444; /* Red close button */
            color: white;
            padding: 0.75rem 1.5rem;
            border-radius: 0.5rem;
            font-weight: 600;
            cursor: pointer;
            transition: background-color 0.3s ease;
        }
        .modal-close-btn:hover {
            background-color: #dc2626;
        }

        /* New modal for User/Event Info Setup */
        .setup-modal-content {
            background-color: #ffffff;
            padding: 2.5rem;
            border-radius: 1.5rem;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
            max-width: 600px; /* Slightly wider for setup inputs */
            width: 90%;
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
            transform: translateY(-20px);
            transition: transform 0.3s ease;
        }
        .modal-overlay.show .setup-modal-content {
            transform: translateY(0);
        }
        .setup-modal-content label {
            text-align: left;
        }
        .setup-modal-content input {
            text-align: left;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1 class="text-3xl font-bold text-center text-gray-800 mb-6">방문자 출석 관리 시스템</h1>

        <div id="userInfoDisplayCombined" class="user-id-display">
            <p><span class="font-bold">1. 사용자 ID:</span> <span id="displayedUserId">로딩 중...</span></p>
            <p><span class="font-bold">2. 담당자:</span> <span id="displayedManagerInfo">설정되지 않음</span></p>
            <p><span class="font-bold">3. 날짜/장소:</span> <span id="displayedDateTime">설정되지 않음</span></p>
            <p><span class="font-bold">4. 행사명:</span> <span id="displayedEventName">설정되지 않음</span></p>
        </div>

        <div id="mainContent" class="hidden">
            <div class="count-display">
                <div class="count-item">
                    <p>총 방문 예정</p>
                    <span id="totalExpectedVisitors">0</span>
                </div>
                <div class="count-item">
                    <p>현재 방문</p>
                    <span id="currentCheckedIn">0</span>
                </div>
            </div>

            <div id="messageBox" class="message-box hidden"></div>

            <div class="rawdata-section">
                <h2 class="text-2xl font-semibold text-gray-800 mb-4 text-center">1. Rawdata (방문 예정자) CSV 업로드</h2>
                <p class="text-gray-600 mb-4 text-center">
                    첫 행은 헤더(예: `이름,소속,직급,이메일,연락처`)로, 두 번째 행부터 방문자 정보를 입력하세요.<br>
                    각 정보는 **쉼표(`,`)**로 구분됩니다.
                </p>
                <div class="csv-input-group mb-4">
                    <input type="file" id="csvFileInput" accept=".csv">
                    <button id="uploadCsvBtn" class="px-6">CSV 업로드</button>
                </div>
                <p id="rawDataCount" class="text-sm text-gray-500 mt-2 text-center">현재 등록된 예정자: 0명</p>
                <p class="text-sm text-red-500 mt-4 text-center">
                    **주의:** CSV 파일을 업로드하면 **기존 Rawdata가 모두 덮어쓰여집니다.** <br>
                    이미 출석 처리된 방문자의 `is_checked_in` 상태는 Rawdata 상에서 초기화될 수 있습니다.
                </p>
            </div>

            <div class="mt-8">
                <h2 class="2xl font-semibold text-gray-800 mb-4 text-center">2. 방문자 출석 확인</h2>
                <div class="flex gap-2 mb-4">
                    <input type="text" id="visitorNameInput" placeholder="방문자 이름을 입력하세요" class="flex-grow border border-gray-300 focus:ring-blue-500 focus:border-blue-500">
                    <button id="searchVisitorBtn" class="px-6">찾기</button>
                </div>

                <div id="searchResults" class="space-y-3 mt-4">
                    </div>
            </div>

            <div class="mt-8">
                <h2 class="text-2xl font-semibold text-gray-800 mb-4 text-center">3. 출석 완료 방문자</h2>
                <div id="checkedInList" class="space-y-3">
                    </div>
            </div>
        </div>
    </div>

    <div id="warningModal" class="modal-overlay">
        <div class="modal-content">
            <h3 class="modal-title">⚠️ 경고!</h3>
            <p id="modalMessage" class="modal-message"></p>
            <button id="modalCloseBtn" class="modal-close-btn">확인</button>
        </div>
    </div>

    <div id="userInfoSetupModal" class="modal-overlay">
        <div class="setup-modal-content">
            <h3 class="text-2xl font-bold text-indigo-700 mb-4 text-center">사용자 및 행사 정보 설정</h3>
            <p class="text-gray-600 text-center mb-4">앱을 시작하기 전에 기본 정보를 입력해주세요.</p>
            <div class="space-y-3">
                <div>
                    <label for="setupManagerNameInput" class="block text-sm font-medium text-gray-700 mb-1">담당자 이름</label>
                    <input type="text" id="setupManagerNameInput" placeholder="담당자 이름" class="w-full border border-indigo-300 focus:ring-indigo-500 focus:border-indigo-500 bg-white p-2 rounded-lg text-sm">
                </div>
                <div>
                    <label for="setupManagerAffiliationInput" class="block text-sm font-medium text-gray-700 mb-1">담당자 소속</label>
                    <input type="text" id="setupManagerAffiliationInput" placeholder="담당자 소속" class="w-full border border-indigo-300 focus:ring-indigo-500 focus:border-indigo-500 bg-white p-2 rounded-lg text-sm">
                </div>
                <div>
                    <label for="setupEventDateInput" class="block text-sm font-medium text-gray-700 mb-1">행사 날짜</label>
                    <input type="date" id="setupEventDateInput" class="w-full border border-indigo-300 focus:ring-indigo-500 focus:border-indigo-500 bg-white p-2 rounded-lg text-sm">
                </div>
                <div>
                    <label for="setupEventLocationInput" class="block text-sm font-medium text-gray-700 mb-1">행사 장소</label>
                    <input type="text" id="setupEventLocationInput" placeholder="행사 장소" class="w-full border border-indigo-300 focus:ring-indigo-500 focus:border-indigo-500 bg-white p-2 rounded-lg text-sm">
                </div>
                <div>
                    <label for="setupEventNameInput" class="block text-sm font-medium text-gray-700 mb-1">행사명</label>
                    <input type="text" id="setupEventNameInput" placeholder="행사명" class="w-full border border-indigo-300 focus:ring-indigo-500 focus:border-indigo-500 bg-white p-2 rounded-lg text-sm">
                </div>
                <button id="setupSaveUserInfoBtn" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white px-5 py-2 rounded-lg text-sm font-medium transition-colors duration-200 mt-4">정보 저장</button>
            </div>
        </div>
    </div>


    <script type="module">
        // Firebase 앱 초기화 및 서비스 가져오기
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, doc, setDoc, getDoc, updateDoc, query, onSnapshot, orderBy, where, serverTimestamp, addDoc, getDocs } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // 전역 변수 초기화 (Canvas 환경에서 제공됨)
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        let app;
        let db;
        let auth;
        let currentUserId = 'loading...'; // 현재 사용자 ID
        let rawData = []; // 원본 방문 예정자 데이터 (메모리)

        // DOM 요소 가져오기
        const messageBox = document.getElementById('messageBox');
        const csvFileInput = document.getElementById('csvFileInput'); // CSV 파일 입력 필드
        const uploadCsvBtn = document.getElementById('uploadCsvBtn'); // CSV 업로드 버튼
        const rawDataCount = document.getElementById('rawDataCount');
        const visitorNameInput = document.getElementById('visitorNameInput');
        const searchVisitorBtn = document.getElementById('searchVisitorBtn');
        const searchResults = document.getElementById('searchResults');
        const checkedInList = document.getElementById('checkedInList');
        const totalExpectedVisitorsSpan = document.getElementById('totalExpectedVisitors');
        const currentCheckedInSpan = document.getElementById('currentCheckedIn');

        // Main content wrapper
        const mainContent = document.getElementById('mainContent');

        // User/Event Info Setup Modal elements
        const userInfoSetupModal = document.getElementById('userInfoSetupModal');
        const setupManagerNameInput = document.getElementById('setupManagerNameInput');
        const setupManagerAffiliationInput = document.getElementById('setupManagerAffiliationInput');
        const setupEventDateInput = document.getElementById('setupEventDateInput');
        const setupEventLocationInput = document.getElementById('setupEventLocationInput');
        const setupEventNameInput = document.getElementById('setupEventNameInput');
        const setupSaveUserInfoBtn = document.getElementById('setupSaveUserInfoBtn');

        // Display elements for combined user/event info (always visible)
        const userInfoDisplayCombined = document.getElementById('userInfoDisplayCombined');
        const displayedUserId = document.getElementById('displayedUserId');
        const displayedManagerInfo = document.getElementById('displayedManagerInfo');
        const displayedDateTime = document.getElementById('displayedDateTime');
        const displayedEventName = document.getElementById('displayedEventName');

        // Warning Modal elements
        const warningModal = document.getElementById('warningModal');
        const modalMessage = document.getElementById('modalMessage');
        const modalCloseBtn = document.getElementById('modalCloseBtn');

        // --- 유틸리티 함수 ---

        // 기존 메시지 박스에 메시지를 표시하는 함수
        function showMessage(message, type = 'info') {
            messageBox.textContent = message;
            messageBox.classList.remove('hidden', 'bg-red-100', 'text-red-800', 'border-red-400', 'bg-green-100', 'text-green-800', 'border-green-400', 'bg-blue-100', 'text-blue-800', 'border-blue-400');
            messageBox.classList.add('block');

            if (type === 'error') {
                messageBox.classList.add('bg-red-100', 'text-red-800', 'border-red-400');
            } else if (type === 'success') {
                messageBox.classList.add('bg-green-100', 'text-green-800', 'border-green-400');
            } else { // info
                messageBox.classList.add('bg-blue-100', 'text-blue-800', 'border-blue-400');
            }

            setTimeout(() => {
                messageBox.classList.add('hidden');
            }, 5000); // 5초 후 메시지 숨기기
        }

        // 새로운 팝업 모달에 메시지를 표시하는 함수
        function showWarningModalMessage(message) { // Renamed for clarity
            modalMessage.textContent = message;
            warningModal.classList.add('show'); // 모달 표시
        }

        // 팝업 모달을 숨기는 함수
        function hideWarningModalMessage() { // Renamed for clarity
            warningModal.classList.remove('show'); // 모달 숨기기
        }

        // 사용자/행사 정보 설정 모달을 표시하는 함수
        function showUserInfoSetupModal() {
            userInfoSetupModal.classList.add('show');
        }

        // 사용자/행사 정보 설정 모달을 숨기는 함수
        function hideUserInfoSetupModal() {
            userInfoSetupModal.classList.remove('show');
            mainContent.classList.remove('hidden'); // 메인 콘텐츠 표시
        }

        // --- Firebase 초기화 및 인증 ---

        async function initializeFirebase() {
            try {
                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);

                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        currentUserId = user.uid;
                        displayedUserId.textContent = currentUserId; // 통합된 표시에 사용자 ID 업데이트
                        console.log("User signed in:", currentUserId);
                        await loadUserProfile(); // 사용자 로그인 후 사용자 및 행사 프로필 로드 (await 추가)

                        // 필수 정보가 설정되었는지 확인 후 메인 콘텐츠 표시 또는 설정 모달 표시
                        const profileDocRef = doc(db, `artifacts/${appId}/users/${currentUserId}/profile/metadata`);
                        const docSnap = await getDoc(profileDocRef);
                        const data = docSnap.exists() ? docSnap.data() : {};

                        // 담당자 이름, 행사명, 날짜 중 하나라도 없으면 설정 모달 표시
                        if (!data.managerName || !data.eventName || !data.eventDate) {
                            showUserInfoSetupModal();
                        } else {
                            hideUserInfoSetupModal(); // 이미 설정되어 있으면 바로 메인 콘텐츠 표시
                        }

                        loadRawData(); // Rawdata를 메모리에 로드
                        loadCheckedInVisitors();
                    } else {
                        console.log("No user signed in. Attempting sign-in...");
                        try {
                            if (initialAuthToken) {
                                await signInWithCustomToken(auth, initialAuthToken);
                                console.log("Signed in with custom token.");
                            } else {
                                await signInAnonymously(auth);
                                console.log("Signed in anonymously.");
                            }
                        } catch (error) {
                            console.error("Firebase authentication error:", error);
                            showMessage(`인증 오류: ${error.message}`, 'error');
                            displayedUserId.textContent = `인증 실패`; // 통합된 표시에 사용자 ID 업데이트
                            // 인증 실패 시에도 설정 모달을 띄울지 결정 (여기서는 일단 숨김)
                            // showUserInfoSetupModal(); // 필요하다면 인증 실패 시에도 설정 강제
                        }
                    }
                });
            } catch (error) {
                console.error("Firebase initialization failed:", error);
                showMessage(`Firebase 초기화 실패: ${error.message}`, 'error');
            }
        }

        // --- 사용자 및 행사 정보 관리 함수 ---

        // 사용자 및 행사 프로필 로드 함수
        async function loadUserProfile() {
            if (!db || !currentUserId || currentUserId === 'loading...') {
                console.warn("Firestore 또는 사용자 ID가 준비되지 않았습니다. 사용자 프로필 로드를 건너뜁니다.");
                return;
            }
            try {
                // 사용자의 프로필 정보는 users/{uid}/profile/metadata 문서에 저장
                const profileDocRef = doc(db, `artifacts/${appId}/users/${currentUserId}/profile/metadata`);
                const docSnap = await getDoc(profileDocRef);

                let data = {};
                if (docSnap.exists()) {
                    data = docSnap.data();
                }

                // 설정 모달 입력 필드 업데이트
                setupManagerNameInput.value = data.managerName ?? '';
                setupManagerAffiliationInput.value = data.managerAffiliation ?? '';
                setupEventDateInput.value = data.eventDate ?? '';
                setupEventLocationInput.value = data.eventLocation ?? '';
                setupEventNameInput.value = data.eventName ?? '';

                // 표시 영역 업데이트
                const managerName = data.managerName ?? '설정되지 않음';
                const managerAffiliation = data.managerAffiliation ?? '';
                const eventDate = data.eventDate ?? '설정되지 않음';
                const eventLocation = data.eventLocation ?? '';
                const eventName = data.eventName ?? '설정되지 않음';

                // 요청된 형식과 순서대로 표시
                displayedManagerInfo.textContent = `${managerName}${managerAffiliation ? ' / ' + managerAffiliation : ''}`;
                displayedDateTime.textContent = `${eventDate}${eventLocation ? ' / ' + eventLocation : ''}`;
                displayedEventName.textContent = eventName;

                console.log("User profile loaded:", data);
            } catch (e) {
                console.error("Error loading user profile: ", e);
                showMessage(`사용자 정보 로드 중 오류 발생: ${e.message}`, 'error');
            }
        }

        // 사용자 및 행사 정보 저장 함수 (설정 모달용)
        async function saveUserProfileFromSetup() {
            const nameToSave = setupManagerNameInput.value.trim();
            const affiliationToSave = setupManagerAffiliationInput.value.trim();
            const dateToSave = setupEventDateInput.value.trim(); // YYYY-MM-DD 형식
            const locationToSave = setupEventLocationInput.value.trim();
            const eventToSave = setupEventNameInput.value.trim();

            // 필수 정보 확인: 담당자 이름, 행사 날짜, 행사명
            if (!nameToSave || !dateToSave || !eventToSave) {
                showWarningModalMessage('담당자 이름, 행사 날짜, 행사명은 필수 입력 정보입니다.'); // 팝업 메시지 표시
                return; // 함수 실행 중단
            }
            if (!currentUserId || currentUserId === 'loading...') {
                showMessage('사용자 인증 대기 중입니다. 잠시 후 다시 시도해주세요.', 'error');
                return;
            }

            try {
                const profileDocRef = doc(db, `artifacts/${appId}/users/${currentUserId}/profile/metadata`);
                await setDoc(profileDocRef, {
                    managerName: nameToSave,
                    managerAffiliation: affiliationToSave,
                    eventDate: dateToSave,
                    eventLocation: locationToSave,
                    eventName: eventToSave
                }, { merge: true });

                // 저장 후 표시 영역 즉시 업데이트
                displayedManagerInfo.textContent = `${nameToSave}${affiliationToSave ? ' / ' + affiliationToSave : ''}`;
                displayedDateTime.textContent = `${dateToSave}${locationToSave ? ' / ' + locationToSave : ''}`;
                displayedEventName.textContent = eventToSave;

                showMessage('사용자 및 행사 정보가 성공적으로 저장되었습니다!', 'success');
                hideUserInfoSetupModal(); // 정보 저장 성공 시 모달 숨기고 메인 콘텐츠 표시
            } catch (e) {
                console.error("Error saving user profile: ", e);
                showMessage(`사용자 정보 저장 중 오류 발생: ${e.message}`, 'error');
            }
        }

        // --- Rawdata (방문 예정자) CSV 업로드 및 관리 ---

        // CSV 파일 업로드 함수
        async function uploadCsvFile() {
            const file = csvFileInput.files[0];
            if (!file) {
                showMessage('업로드할 CSV 파일을 선택해주세요.', 'error');
                return;
            }

            if (!currentUserId || currentUserId === 'loading...') {
                showMessage('사용자 인증 대기 중입니다. 잠시 후 다시 시도해주세요.', 'error');
                return;
            }

            const reader = new FileReader();
            reader.onload = async (e) => {
                const text = e.target.result;
                const lines = text.split('\n').filter(line => line.trim() !== ''); // 빈 줄 제거
                const parsedData = [];

                if (lines.length === 0) {
                    showMessage('CSV 파일에 내용이 없습니다.', 'error');
                    return;
                }

                // 첫 번째 줄은 헤더로 간주하고 건너뛰기
                const header = lines[0].split(',').map(h => h.trim());
                if (header.length !== 5 || header[0] !== '이름' || header[1] !== '소속' || header[2] !== '직급' || header[3] !== '이메일' || header[4] !== '연락처') {
                    showMessage('CSV 헤더 형식이 올바르지 않습니다. "이름,소속,직급,이메일,연락처" 형식이어야 합니다.', 'error');
                    return;
                }

                for (let i = 1; i < lines.length; i++) { // 두 번째 줄부터 데이터 파싱 시작
                    const line = lines[i];
                    const parts = line.split(',').map(p => p.trim()); // 쉼표로 구분

                    if (parts.length === 5) { // 이름,소속,직급,이메일,연락처 5가지 정보 확인
                        parsedData.push({
                            name: parts[0] || '',
                            affiliation: parts[1] || '',
                            position: parts[2] || '',
                            email: parts[3] || '',
                            contact: parts[4] || '',
                            is_checked_in: false // CSV 업로드 시 초기화 (출석 상태는 별도로 관리)
                        });
                    } else {
                        showMessage(`잘못된 형식의 줄이 있습니다 (줄 ${i + 1}): ${line}. '이름,소속,직급,이메일,연락처' 형식이어야 합니다.`, 'error');
                        return; // 형식 오류 시 중단
                    }
                }

                try {
                    // Rawdata는 사용자별로 저장되며, 하나의 문서에 모든 예정자 정보를 배열로 저장
                    // 새 CSV 업로드 시 기존 데이터 덮어쓰기
                    const rawDataDocRef = doc(db, `artifacts/${appId}/users/${currentUserId}/config/rawData`);
                    await setDoc(rawDataDocRef, { visitors: parsedData });
                    showMessage('CSV 파일이 성공적으로 업로드 및 저장되었습니다!', 'success');
                    rawData = parsedData; // 메모리에도 업데이트
                    updateExpectedVisitorCount(); // 총 방문 예정자 수 업데이트
                    csvFileInput.value = ''; // 파일 입력 필드 초기화
                } catch (e) {
                    console.error("Error saving raw data from CSV: ", e);
                    showMessage(`CSV Rawdata 저장 중 오류 발생: ${e.message}`, 'error');
                }
            };
            reader.onerror = (e) => {
                showMessage(`파일 읽기 오류: ${e.message}`, 'error');
                console.error("File reading error:", e);
            };
            reader.readAsText(file); // 파일을 텍스트로 읽기
        }

        // Rawdata 로드 함수 (앱 시작 시 메모리에 로드)
        async function loadRawData() {
            if (!db || !currentUserId || currentUserId === 'loading...') {
                console.warn("Firestore 또는 사용자 ID가 준비되지 않았습니다. Rawdata 로드를 건너뜁니다.");
                return;
            }
            try {
                const rawDataDocRef = doc(db, `artifacts/${appId}/users/${currentUserId}/config/rawData`);
                const docSnap = await getDoc(rawDataDocRef);

                if (docSnap.exists()) {
                    rawData = docSnap.data().visitors || [];
                    console.log("Rawdata loaded successfully from Firestore.");
                } else {
                    console.log("No raw data found for this user. Starting with empty list.");
                    rawData = [];
                }
                updateExpectedVisitorCount(); // 총 방문 예정자 수 업데이트
            } catch (e) {
                console.error("Error loading raw data: ", e);
                showMessage(`Rawdata 로드 중 오류 발생: ${e.message}`, 'error');
            }
        }

        // 총 방문 예정자 수 업데이트
        function updateExpectedVisitorCount() {
            totalExpectedVisitorsSpan.textContent = rawData.length;
            rawDataCount.textContent = `현재 등록된 예정자: ${rawData.length}명`;
        }

        // --- 방문자 출석 확인 로직 ---

        // 방문자 검색 및 표시
        function searchVisitor() {
            const searchName = visitorNameInput.value.trim().toLowerCase();
            searchResults.innerHTML = ''; // 검색 결과 초기화

            if (!searchName) {
                showMessage('방문자 이름을 입력해주세요.', 'info');
                return;
            }

            if (rawData.length === 0) {
                showMessage('등록된 방문 예정자 Rawdata가 없습니다. 먼저 CSV 파일을 업로드해주세요.', 'error');
                return;
            }

            // 검색어에 '포함'되는 이름으로 검색 (대소문자 구분 없음)
            const matchedVisitors = rawData.filter(visitor =>
                visitor.name.toLowerCase().includes(searchName)
            );

            if (matchedVisitors.length === 0) {
                // 이름이 동일한 사람이 없는 경우
                searchResults.innerHTML = `
                    <p class="search-results-title">검색 결과: "${searchName}" 이름의 예정자가 없습니다.</p>
                    <div class="visitor-item">
                        <p class="text-lg font-medium text-red-700">일치하는 방문자가 없습니다.</p>
                        <p class="text-sm text-gray-600">이름: ${searchName}으로 새로운 방문자를 등록하시겠습니까?</p>
                        <button class="match-action-btn" onclick="checkInNewVisitor('${searchName.replace(/'/g, "\\'")}')">새 방문자 출석 처리</button>
                    </div>
                `;
            } else {
                // 이름이 동일한 사람이 있는 경우 (모두 표시)
                searchResults.innerHTML = `<p class="search-results-title">"${searchName}" 검색 결과 (${matchedVisitors.length}명):</p>`;
                matchedVisitors.forEach((visitor, index) => {
                    const visitorItem = document.createElement('div');
                    visitorItem.classList.add('visitor-item');

                    visitorItem.innerHTML = `
                        <p class="text-lg font-medium text-gray-900">${visitor.name}</p>
                        <p class="text-sm text-gray-600">소속: ${visitor.affiliation || '-'}</p>
                        <p class="text-sm text-gray-600">직급: ${visitor.position || '-'}</p>
                        <p class="text-sm text-gray-600">이메일: ${visitor.email || '-'}</p>
                        <p class="text-sm text-gray-600">연락처: ${visitor.contact || '-'}</p>
                        <button class="match-action-btn" onclick="checkInVisitor(
                            '${visitor.name.replace(/'/g, "\\'")}',
                            '${visitor.affiliation.replace(/'/g, "\\'")}',
                            '${visitor.position.replace(/'/g, "\\'")}',
                            '${visitor.email.replace(/'/g, "\\'")}',
                            '${visitor.contact.replace(/'/g, "\\'")}'
                        )">출석 처리</button>
                    `;
                    searchResults.appendChild(visitorItem);
                });
            }
        }

        // 선택된 방문자를 출석 처리 (기존 예정자)
        // 전역 함수로 노출
        window.checkInVisitor = async function(name, affiliation, position, email, contact) {
            if (!currentUserId || currentUserId === 'loading...') {
                showMessage('사용자 인증 대기 중입니다. 잠시 후 다시 시도해주세요.', 'error');
                return;
            }

            try {
                const checkedInVisitorsRef = collection(db, `artifacts/${appId}/users/${currentUserId}/checkedInVisitors`);

                // 중복 확인: 이름과 이메일로 검색. 이메일이 없는 경우 이름과 연락처로 검색.
                let q;
                if (email && email !== '' && email !== '-') { // 이메일이 유효한 경우
                    q = query(checkedInVisitorsRef,
                        where("name", "==", name),
                        where("email", "==", email)
                    );
                } else if (contact && contact !== '' && contact !== '-') { // 이메일이 없고 연락처가 유효한 경우
                    q = query(checkedInVisitorsRef,
                        where("name", "==", name),
                        where("contact", "==", contact)
                    );
                } else { // 이메일과 연락처 모두 없는 경우 (이름으로만 중복 확인, 정확도 낮음)
                    q = query(checkedInVisitorsRef,
                        where("name", "==", name)
                    );
                }

                const querySnapshot = await getDocs(q);
                if (!querySnapshot.empty) {
                    showWarningModalMessage('이미 등록된 방문자입니다!'); // 팝업 메시지 표시
                    return; // 함수 실행 중단
                }

                // 중복이 아니면 출석 완료 기록 추가
                await addDoc(checkedInVisitorsRef, {
                    name: name,
                    affiliation: affiliation,
                    position: position,
                    email: email,
                    contact: contact,
                    checked_in_at: serverTimestamp() // Firebase 서버 시간 사용
                });

                showMessage(`${name}님의 출석이 완료되었습니다!`, 'success');
                visitorNameInput.value = ''; // 입력 필드 초기화
                searchResults.innerHTML = ''; // 검색 결과 초기화
            } catch (e) {
                console.error("Error checking in visitor: ", e);
                showMessage(`출석 처리 중 오류 발생: ${e.message}`, 'error');
            }
        }

        // 새로운 방문자 출석 처리
        // 전역 함수로 노출
        window.checkInNewVisitor = async function(name) {
            if (!currentUserId || currentUserId === 'loading...') {
                showMessage('사용자 인증 대기 중입니다. 잠시 후 다시 시도해주세요.', 'error');
                return;
            }

            try {
                const checkedInVisitorsRef = collection(db, `artifacts/${appId}/users/${currentUserId}/checkedInVisitors`);

                // 새로운 방문자는 이름으로만 중복 확인
                const q = query(checkedInVisitorsRef,
                    where("name", "==", name)
                );
                const querySnapshot = await getDocs(q);
                if (!querySnapshot.empty) {
                    showWarningModalMessage('이미 등록된 방문자입니다!'); // 팝업 메시지 표시
                    return; // 함수 실행 중단
                }

                await addDoc(checkedInVisitorsRef, {
                    name: name,
                    affiliation: '미등록', // 새 방문자는 정보가 없으므로 '미등록'
                    position: '미등록',
                    email: '미등록',
                    contact: '미등록',
                    checked_in_at: serverTimestamp()
                });
                showMessage(`새 방문자 (${name})의 출석이 완료되었습니다!`, 'success');
                visitorNameInput.value = ''; // 입력 필드 초기화
                searchResults.innerHTML = ''; // 검색 결과 초기화
            } catch (e) {
                console.error("Error checking in new visitor: ", e);
                showMessage(`새 방문자 출석 처리 중 오류 발생: ${e.message}`, 'error');
            }
        }

        // --- 출석 완료 방문자 목록 및 집계 ---

        // 출석 완료 방문자 실시간 로드 및 집계
        function loadCheckedInVisitors() {
            if (!db || !currentUserId || currentUserId === 'loading...') {
                console.warn("Firestore 또는 사용자 ID가 준비되지 않았습니다. 출석 완료 방문자 로드를 건너뜁니다.");
                return;
            }

            const checkedInVisitorsRef = collection(db, `artifacts/${appId}/users/${currentUserId}/checkedInVisitors`);
            // 최신 출석 기록이 위에 오도록 정렬
            const q = query(checkedInVisitorsRef, orderBy('checked_in_at', 'desc'));

            onSnapshot(q, (snapshot) => {
                checkedInList.innerHTML = ''; // 목록 초기화
                let checkedInCount = 0;
                // 현재 출석 완료된 방문자 이름을 빠르게 찾기 위한 Set
                const currentlyCheckedInNames = new Set();

                snapshot.forEach((doc) => {
                    const visitor = doc.data();
                    checkedInCount++;
                    const checkedInItem = document.createElement('div');
                    checkedInItem.classList.add('checked-in-item');
                    const checkedInTime = visitor.checked_in_at ? visitor.checked_in_at.toDate().toLocaleString('ko-KR') : '시간 정보 없음'; // 한국 시간 포맷
                    checkedInItem.innerHTML = `
                        <p class="text-lg font-medium text-gray-900">${visitor.name}</p>
                        <p class="text-sm text-gray-600">소속: ${visitor.affiliation || '-'}</p>
                        <p class="text-sm text-gray-600">직급: ${visitor.position || '-'}</p>
                        <p class="text-sm text-gray-600">이메일: ${visitor.email || '-'}</p>
                        <p class="text-sm text-gray-600">연락처: ${visitor.contact || '-'}</p>
                        <p class="text-sm text-gray-600">출석 시간: ${checkedInTime}</p>
                    `;
                    checkedInList.appendChild(checkedInItem);

                    currentlyCheckedInNames.add(visitor.name.toLowerCase()); // 중복 출석 방지를 위해 이름 저장
                });
                currentCheckedInSpan.textContent = checkedInCount; // 현재 방문자 수 업데이트
                if (checkedInCount === 0) {
                    checkedInList.innerHTML = '<p class="text-gray-500 text-center">아직 출석 완료된 방문자가 없습니다.</p>';
                }

                // 매칭 결과 표시 업데이트 (이미 출석한 사람 표시)
                const searchName = visitorNameInput.value.trim().toLowerCase();
                if (searchName) {
                    const currentSearchResults = searchResults.innerHTML;
                    if (currentSearchResults) {
                        const tempDiv = document.createElement('div');
                        tempDiv.innerHTML = currentSearchResults;
                        const visitorItems = tempDiv.querySelectorAll('.visitor-item');
                        visitorItems.forEach(item => {
                            const nameElement = item.querySelector('p.text-lg.font-medium');
                            if (nameElement) {
                                const visitorName = nameElement.textContent.trim().toLowerCase();
                                const button = item.querySelector('button.match-action-btn');
                                const existingMessage = item.querySelector('p.text-md.font-bold');

                                if (currentlyCheckedInNames.has(visitorName)) {
                                    if (button) button.remove();
                                    if (!existingMessage) {
                                        const p = document.createElement('p');
                                        p.classList.add('text-md', 'font-bold', 'text-green-600', 'mt-2');
                                        p.textContent = '✅ 이미 출석 완료되었습니다.';
                                        item.appendChild(p);
                                    }
                                } else {
                                     if (existingMessage) existingMessage.remove();
                                     if (!button && nameElement.textContent.trim() !== '일치하는 방문자가 없습니다.') {
                                        const visitorData = rawData.find(v => v.name.toLowerCase() === visitorName);
                                        if (visitorData) {
                                            const newButton = document.createElement('button');
                                            newButton.classList.add('match-action-btn');
                                            newButton.textContent = '출석 처리';
                                            newButton.onclick = () => window.checkInVisitor(
                                                visitorData.name,
                                                visitorData.affiliation,
                                                visitorData.position,
                                                visitorData.email,
                                                visitorData.contact
                                            );
                                            item.appendChild(newButton);
                                        }
                                     }
                                }
                            }
                        });
                        searchResults.innerHTML = tempDiv.innerHTML;
                    }
                }
            }, (error) => {
                console.error("Error fetching checked-in visitors: ", error);
                showMessage(`출석 완료 방문자 로드 중 오류 발생: ${error.message}`, 'error');
            });
        }

        // --- 이벤트 리스너 설정 ---

        uploadCsvBtn.addEventListener('click', uploadCsvFile);
        searchVisitorBtn.addEventListener('click', searchVisitor);
        visitorNameInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                searchVisitor();
            }
        });

        // 사용자 및 행사 정보 저장 버튼 이벤트 리스너 (새로운 버튼)
        setupSaveUserInfoBtn.addEventListener('click', saveUserProfileFromSetup);

        // 경고 모달 닫기 버튼 이벤트 리스너
        modalCloseBtn.addEventListener('click', hideWarningModalMessage);
        // 경고 모달 오버레이 클릭 시 닫기 (선택 사항)
        warningModal.addEventListener('click', (e) => {
            if (e.target === warningModal) {
                hideWarningModalMessage();
            }
        });

        // --- 앱 시작 ---
        initializeFirebase();
    </script>
</body>
</html>
