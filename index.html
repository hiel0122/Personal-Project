<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ë°©ë¬¸ì ì¶œì„ ê´€ë¦¬ ì•± (ì„¤ì • ì„ í–‰)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0f4f8;
            display: flex;
            justify-content: center;
            align-items: flex-start;
            min-height: 100vh;
            padding: 2rem;
            box-sizing: border-box;
        }
        .container {
            background-color: #ffffff;
            padding: 2.5rem;
            border-radius: 1.5rem;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
            width: 100%;
            max-width: 800px; /* ì»¨í…Œì´ë„ˆ ë„ˆë¹„ í™•ì¥ */
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
        }
        input[type="text"], input[type="file"], input[type="date"], button {
            border-radius: 0.75rem;
            padding: 0.75rem 1.25rem;
            font-size: 1rem;
        }
        button {
            background-color: #4f46e5;
            color: white;
            font-weight: 600;
            transition: background-color 0.3s ease;
            box-shadow: 0 4px 10px rgba(79, 70, 229, 0.3);
        }
        button:hover {
            background-color: #4338ca;
        }
        .message-box {
            background-color: #e0f2fe;
            color: #0c4a6e;
            padding: 0.75rem;
            border-radius: 0.75rem;
            margin-top: 1rem;
            font-size: 0.9rem;
            border: 1px solid #90cdf4;
        }
        .visitor-item, .checked-in-item {
            background-color: #f8fafc;
            padding: 1rem;
            border-radius: 0.75rem;
            border: 1px solid #e2e8f0;
            display: flex;
            flex-direction: column; /* ì„¸ë¡œ ì •ë ¬ */
            gap: 0.5rem; /* í•­ëª© ê°„ ê°„ê²© */
            margin-bottom: 0.75rem;
        }
        .visitor-item.matched {
            background-color: #d1fae5; /* ë§¤ì¹­ ì™„ë£Œ ì‹œ ë…¹ìƒ‰ */
            border-color: #34d399;
        }
        .visitor-item:last-child, .checked-in-item:last-child {
            margin-bottom: 0;
        }
        .user-id-display { /* ì´ í´ë˜ìŠ¤ëŠ” ì´ì œ í†µí•©ëœ ì •ë³´ í‘œì‹œì— ì‚¬ìš©ë©ë‹ˆë‹¤. */
            background-color: #f0f9ff;
            color: #1e40af;
            padding: 0.75rem;
            border-radius: 0.75rem;
            font-size: 0.9rem; /* í°íŠ¸ í¬ê¸° ì¡°ì • */
            word-break: break-all;
            border: 1px solid #bfdbfe;
            margin-top: 1rem;
        }
        .user-id-display p {
            margin-bottom: 0.4rem; /* ê° ì¤„ ê°„ê²© */
        }
        .user-id-display p:last-child {
            margin-bottom: 0;
        }

        .count-display {
            display: flex;
            justify-content: space-around;
            background-color: #eef2ff;
            padding: 1rem;
            border-radius: 1rem;
            box-shadow: inset 0 2px 5px rgba(0, 0, 0, 0.05);
            margin-bottom: 1.5rem;
        }
        .count-item {
            text-align: center;
            font-weight: 600;
            color: #4a5568;
        }
        .count-item span {
            display: block;
            font-size: 2.5rem;
            color: #4f46e5;
            line-height: 1;
            margin-bottom: 0.25rem;
        }
        .match-action-btn {
            background-color: #10b981; /* ë…¹ìƒ‰ */
            margin-top: 0.5rem;
        }
        .match-action-btn:hover {
            background-color: #059669;
        }
        .search-results-title {
            font-size: 1.25rem;
            font-weight: 600;
            color: #4a5568;
            margin-top: 1rem;
            margin-bottom: 1rem;
        }
        .rawdata-section {
            background-color: #f0f9ff;
            padding: 1.5rem;
            border-radius: 1.5rem;
            border: 1px dashed #bfdbfe;
            margin-top: 2rem;
        }
        .csv-input-group {
            display: flex;
            gap: 1rem;
            align-items: center;
        }
        .csv-input-group input[type="file"] {
            flex-grow: 1;
            padding: 0.5rem;
            border: 1px solid #d1d5db;
            border-radius: 0.75rem;
            background-color: #fff;
            cursor: pointer;
        }

        /* Modal specific styles */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease, visibility 0.3s ease;
        }
        .modal-overlay.show {
            opacity: 1;
            visibility: visible;
        }
        .modal-content {
            background-color: white;
            padding: 2rem;
            border-radius: 1rem;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
            text-align: center;
            max-width: 400px;
            width: 90%;
            transform: translateY(-20px);
            transition: transform 0.3s ease;
        }
        .modal-overlay.show .modal-content {
            transform: translateY(0);
        }
        .modal-title {
            font-size: 1.5rem;
            font-weight: 700;
            color: #ef4444; /* Red for warning */
            margin-bottom: 1rem;
        }
        .modal-message {
            font-size: 1.1rem;
            color: #374151;
            margin-bottom: 1.5rem;
        }
        .modal-close-btn {
            background-color: #ef4444; /* Red close button */
            color: white;
            padding: 0.75rem 1.5rem;
            border-radius: 0.5rem;
            font-weight: 600;
            cursor: pointer;
            transition: background-color 0.3s ease;
        }
        .modal-close-btn:hover {
            background-color: #dc2626;
        }

        /* New modal for User/Event Info Setup */
        .setup-modal-content {
            background-color: #ffffff;
            padding: 2.5rem;
            border-radius: 1.5rem;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
            max-width: 600px; /* Slightly wider for setup inputs */
            width: 90%;
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
            transform: translateY(-20px);
            transition: transform 0.3s ease;
        }
        .modal-overlay.show .setup-modal-content {
            transform: translateY(0);
        }
        .setup-modal-content label {
            text-align: left;
        }
        .setup-modal-content input {
            text-align: left;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1 class="text-3xl font-bold text-center text-gray-800 mb-6">ë°©ë¬¸ì ì¶œì„ ê´€ë¦¬ ì‹œìŠ¤í…œ</h1>

        <div id="userInfoDisplayCombined" class="user-id-display">
            <p><span class="font-bold">1. ì‚¬ìš©ì ID:</span> <span id="displayedUserId">ë¡œë”© ì¤‘...</span></p>
            <p><span class="font-bold">2. ë‹´ë‹¹ì:</span> <span id="displayedManagerInfo">ì„¤ì •ë˜ì§€ ì•ŠìŒ</span></p>
            <p><span class="font-bold">3. ë‚ ì§œ/ì¥ì†Œ:</span> <span id="displayedDateTime">ì„¤ì •ë˜ì§€ ì•ŠìŒ</span></p>
            <p><span class="font-bold">4. í–‰ì‚¬ëª…:</span> <span id="displayedEventName">ì„¤ì •ë˜ì§€ ì•ŠìŒ</span></p>
        </div>

        <div id="mainContent" class="hidden">
            <div class="count-display">
                <div class="count-item">
                    <p>ì´ ë°©ë¬¸ ì˜ˆì •</p>
                    <span id="totalExpectedVisitors">0</span>
                </div>
                <div class="count-item">
                    <p>í˜„ì¬ ë°©ë¬¸</p>
                    <span id="currentCheckedIn">0</span>
                </div>
            </div>

            <div id="messageBox" class="message-box hidden"></div>

            <div class="rawdata-section">
                <h2 class="text-2xl font-semibold text-gray-800 mb-4 text-center">1. Rawdata (ë°©ë¬¸ ì˜ˆì •ì) CSV ì—…ë¡œë“œ</h2>
                <p class="text-gray-600 mb-4 text-center">
                    ì²« í–‰ì€ í—¤ë”(ì˜ˆ: `ì´ë¦„,ì†Œì†,ì§ê¸‰,ì´ë©”ì¼,ì—°ë½ì²˜`)ë¡œ, ë‘ ë²ˆì§¸ í–‰ë¶€í„° ë°©ë¬¸ì ì •ë³´ë¥¼ ì…ë ¥í•˜ì„¸ìš”.<br>
                    ê° ì •ë³´ëŠ” **ì‰¼í‘œ(`,`)**ë¡œ êµ¬ë¶„ë©ë‹ˆë‹¤.
                </p>
                <div class="csv-input-group mb-4">
                    <input type="file" id="csvFileInput" accept=".csv">
                    <button id="uploadCsvBtn" class="px-6">CSV ì—…ë¡œë“œ</button>
                </div>
                <p id="rawDataCount" class="text-sm text-gray-500 mt-2 text-center">í˜„ì¬ ë“±ë¡ëœ ì˜ˆì •ì: 0ëª…</p>
                <p class="text-sm text-red-500 mt-4 text-center">
                    **ì£¼ì˜:** CSV íŒŒì¼ì„ ì—…ë¡œë“œí•˜ë©´ **ê¸°ì¡´ Rawdataê°€ ëª¨ë‘ ë®ì–´ì“°ì—¬ì§‘ë‹ˆë‹¤.** <br>
                    ì´ë¯¸ ì¶œì„ ì²˜ë¦¬ëœ ë°©ë¬¸ìì˜ `is_checked_in` ìƒíƒœëŠ” Rawdata ìƒì—ì„œ ì´ˆê¸°í™”ë  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
                </p>
            </div>

            <div class="mt-8">
                <h2 class="2xl font-semibold text-gray-800 mb-4 text-center">2. ë°©ë¬¸ì ì¶œì„ í™•ì¸</h2>
                <div class="flex gap-2 mb-4">
                    <input type="text" id="visitorNameInput" placeholder="ë°©ë¬¸ì ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”" class="flex-grow border border-gray-300 focus:ring-blue-500 focus:border-blue-500">
                    <button id="searchVisitorBtn" class="px-6">ì°¾ê¸°</button>
                </div>

                <div id="searchResults" class="space-y-3 mt-4">
                    </div>
            </div>

            <div class="mt-8">
                <h2 class="text-2xl font-semibold text-gray-800 mb-4 text-center">3. ì¶œì„ ì™„ë£Œ ë°©ë¬¸ì</h2>
                <div id="checkedInList" class="space-y-3">
                    </div>
            </div>
        </div>
    </div>

    <div id="warningModal" class="modal-overlay">
        <div class="modal-content">
            <h3 class="modal-title">âš ï¸ ê²½ê³ !</h3>
            <p id="modalMessage" class="modal-message"></p>
            <button id="modalCloseBtn" class="modal-close-btn">í™•ì¸</button>
        </div>
    </div>

    <div id="userInfoSetupModal" class="modal-overlay">
        <div class="setup-modal-content">
            <h3 class="text-2xl font-bold text-indigo-700 mb-4 text-center">ì‚¬ìš©ì ë° í–‰ì‚¬ ì •ë³´ ì„¤ì •</h3>
            <p class="text-gray-600 text-center mb-4">ì•±ì„ ì‹œì‘í•˜ê¸° ì „ì— ê¸°ë³¸ ì •ë³´ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.</p>
            <div class="space-y-3">
                <div>
                    <label for="setupManagerNameInput" class="block text-sm font-medium text-gray-700 mb-1">ë‹´ë‹¹ì ì´ë¦„</label>
                    <input type="text" id="setupManagerNameInput" placeholder="ë‹´ë‹¹ì ì´ë¦„" class="w-full border border-indigo-300 focus:ring-indigo-500 focus:border-indigo-500 bg-white p-2 rounded-lg text-sm">
                </div>
                <div>
                    <label for="setupManagerAffiliationInput" class="block text-sm font-medium text-gray-700 mb-1">ë‹´ë‹¹ì ì†Œì†</label>
                    <input type="text" id="setupManagerAffiliationInput" placeholder="ë‹´ë‹¹ì ì†Œì†" class="w-full border border-indigo-300 focus:ring-indigo-500 focus:border-indigo-500 bg-white p-2 rounded-lg text-sm">
                </div>
                <div>
                    <label for="setupEventDateInput" class="block text-sm font-medium text-gray-700 mb-1">í–‰ì‚¬ ë‚ ì§œ</label>
                    <input type="date" id="setupEventDateInput" class="w-full border border-indigo-300 focus:ring-indigo-500 focus:border-indigo-500 bg-white p-2 rounded-lg text-sm">
                </div>
                <div>
                    <label for="setupEventLocationInput" class="block text-sm font-medium text-gray-700 mb-1">í–‰ì‚¬ ì¥ì†Œ</label>
                    <input type="text" id="setupEventLocationInput" placeholder="í–‰ì‚¬ ì¥ì†Œ" class="w-full border border-indigo-300 focus:ring-indigo-500 focus:border-indigo-500 bg-white p-2 rounded-lg text-sm">
                </div>
                <div>
                    <label for="setupEventNameInput" class="block text-sm font-medium text-gray-700 mb-1">í–‰ì‚¬ëª…</label>
                    <input type="text" id="setupEventNameInput" placeholder="í–‰ì‚¬ëª…" class="w-full border border-indigo-300 focus:ring-indigo-500 focus:border-indigo-500 bg-white p-2 rounded-lg text-sm">
                </div>
                <button id="setupSaveUserInfoBtn" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white px-5 py-2 rounded-lg text-sm font-medium transition-colors duration-200 mt-4">ì •ë³´ ì €ì¥</button>
            </div>
        </div>
    </div>


    <script type="module">
        // Firebase ì•± ì´ˆê¸°í™” ë° ì„œë¹„ìŠ¤ ê°€ì ¸ì˜¤ê¸°
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, doc, setDoc, getDoc, updateDoc, query, onSnapshot, orderBy, where, serverTimestamp, addDoc, getDocs } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

 // Import the functions you need from the SDKs you need
// TODO: Add SDKs for Firebase products that you want to use
// https://firebase.google.com/docs/web/setup#available-libraries

// Your web app's Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyA--nzAG6DKUTVZ8Bcq7e2J-Ha8Lf2uMMI",
             authDomain: "autochecking-c4c22.firebaseapp.com",
             projectId: "autochecking-c4c22",
             storageBucket: "autochecking-c4c22.firebasestorage.app",
             messagingSenderId: "439994089371",
             appId: "1:439994089371:web:9ce9fe4665f1dcf5406b3e"
        };

/ ì´ ì•±ì˜ ê³ ìœ  ID (Firebase App IDë¥¼ ì‚¬ìš©í•˜ë©´ ì¼ê´€ì„±ì„ ìœ ì§€í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.)
const appId = firebaseConfig.appId;
// ì´ˆê¸° ì¸ì¦ í† í°ì€ Canvas í™˜ê²½ì—ì„œ ë§Œ ì£¼ì…ë˜ë¯€ë¡œ, ë¡œì»¬ ë°°í¬ ì‹œì—ëŠ” nullë¡œ ì„¤ì •í•©ë‹ˆë‹¤.
const initialAuthToken = null;

// Firebase ì•± ì´ˆê¸°í™” ë° ì„œë¹„ìŠ¤ ë³€ìˆ˜ ì„ ì–¸ (ë”± í•œ ë²ˆ!)
let app = initializeApp(firebaseConfig); // ğŸ‘ˆ ì—¬ê¸°ì„œ appì„ ì´ˆê¸°í™”í•©ë‹ˆë‹¤.
let db = getFirestore(app); // ğŸ‘ˆ dbë„ ì—¬ê¸°ì„œ ì´ˆê¸°í™”í•©ë‹ˆë‹¤.
let auth = getAuth(app);   // ğŸ‘ˆ authë„ ì—¬ê¸°ì„œ ì´ˆê¸°í™”í•©ë‹ˆë‹¤.

let currentUserId = 'loading...'; // í˜„ì¬ ì‚¬ìš©ì ID
let rawData = []; // ì›ë³¸ ë°©ë¬¸ ì˜ˆì •ì ë°ì´í„° (ë©”ëª¨ë¦¬)

// DOM ìš”ì†Œ ê°€ì ¸ì˜¤ê¸° (ê° ìš”ì†ŒëŠ” í•œ ë²ˆë§Œ ì„ ì–¸ë˜ì–´ì•¼ í•©ë‹ˆë‹¤.)
        const messageBox = document.getElementById('messageBox');
        const csvFileInput = document.getElementById('csvFileInput'); // CSV íŒŒì¼ ì…ë ¥ í•„ë“œ
        const uploadCsvBtn = document.getElementById('uploadCsvBtn'); // CSV ì—…ë¡œë“œ ë²„íŠ¼
        const rawDataCount = document.getElementById('rawDataCount');
        const visitorNameInput = document.getElementById('visitorNameInput');
        const searchVisitorBtn = document.getElementById('searchVisitorBtn');
        const searchResults = document.getElementById('searchResults');
        const checkedInList = document.getElementById('checkedInList');
        const totalExpectedVisitorsSpan = document.getElementById('totalExpectedVisitors');
        const currentCheckedInSpan = document.getElementById('currentCheckedIn');

        // Main content wrapper
        const mainContent = document.getElementById('mainContent');

        // User/Event Info Setup Modal elements
        const userInfoSetupModal = document.getElementById('userInfoSetupModal');
        const setupManagerNameInput = document.getElementById('setupManagerNameInput');
        const setupManagerAffiliationInput = document.getElementById('setupManagerAffiliationInput');
        const setupEventDateInput = document.getElementById('setupEventDateInput');
        const setupEventLocationInput = document.getElementById('setupEventLocationInput');
        const setupEventNameInput = document.getElementById('setupEventNameInput');
        const setupSaveUserInfoBtn = document.getElementById('setupSaveUserInfoBtn');

        // Display elements for combined user/event info (always visible)
        const userInfoDisplayCombined = document.getElementById('userInfoDisplayCombined');
        const displayedUserId = document.getElementById('displayedUserId');
        const displayedManagerInfo = document.getElementById('displayedManagerInfo');
        const displayedDateTime = document.getElementById('displayedDateTime');
        const displayedEventName = document.getElementById('displayedEventName');

        // Warning Modal elements
        const warningModal = document.getElementById('warningModal');
        const modalMessage = document.getElementById('modalMessage');
        const modalCloseBtn = document.getElementById('modalCloseBtn');

        // --- ìœ í‹¸ë¦¬í‹° í•¨ìˆ˜ ---

        // ê¸°ì¡´ ë©”ì‹œì§€ ë°•ìŠ¤ì— ë©”ì‹œì§€ë¥¼ í‘œì‹œí•˜ëŠ” í•¨ìˆ˜
        function showMessage(message, type = 'info') {
            messageBox.textContent = message;
            messageBox.classList.remove('hidden', 'bg-red-100', 'text-red-800', 'border-red-400', 'bg-green-100', 'text-green-800', 'border-green-400', 'bg-blue-100', 'text-blue-800', 'border-blue-400');
            messageBox.classList.add('block');

            if (type === 'error') {
                messageBox.classList.add('bg-red-100', 'text-red-800', 'border-red-400');
            } else if (type === 'success') {
                messageBox.classList.add('bg-green-100', 'text-green-800', 'border-green-400');
            } else { // info
                messageBox.classList.add('bg-blue-100', 'text-blue-800', 'border-blue-400');
            }

            setTimeout(() => {
                messageBox.classList.add('hidden');
            }, 5000); // 5ì´ˆ í›„ ë©”ì‹œì§€ ìˆ¨ê¸°ê¸°
        }

        // ìƒˆë¡œìš´ íŒì—… ëª¨ë‹¬ì— ë©”ì‹œì§€ë¥¼ í‘œì‹œí•˜ëŠ” í•¨ìˆ˜
        function showWarningModalMessage(message) { // Renamed for clarity
            modalMessage.textContent = message;
            warningModal.classList.add('show'); // ëª¨ë‹¬ í‘œì‹œ
        }

        // íŒì—… ëª¨ë‹¬ì„ ìˆ¨ê¸°ëŠ” í•¨ìˆ˜
        function hideWarningModalMessage() { // Renamed for clarity
            warningModal.classList.remove('show'); // ëª¨ë‹¬ ìˆ¨ê¸°ê¸°
        }

        // ì‚¬ìš©ì/í–‰ì‚¬ ì •ë³´ ì„¤ì • ëª¨ë‹¬ì„ í‘œì‹œí•˜ëŠ” í•¨ìˆ˜
        function showUserInfoSetupModal() {
            userInfoSetupModal.classList.add('show');
        }

        // ì‚¬ìš©ì/í–‰ì‚¬ ì •ë³´ ì„¤ì • ëª¨ë‹¬ì„ ìˆ¨ê¸°ëŠ” í•¨ìˆ˜
        function hideUserInfoSetupModal() {
            userInfoSetupModal.classList.remove('show');
            mainContent.classList.remove('hidden'); // ë©”ì¸ ì½˜í…ì¸  í‘œì‹œ
        }

        // --- Firebase ì´ˆê¸°í™” ë° ì¸ì¦ ---

        async function initializeFirebase() {
            try {
                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);

                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        currentUserId = user.uid;
                        displayedUserId.textContent = currentUserId; // í†µí•©ëœ í‘œì‹œì— ì‚¬ìš©ì ID ì—…ë°ì´íŠ¸
                        console.log("User signed in:", currentUserId);
                        await loadUserProfile(); // ì‚¬ìš©ì ë¡œê·¸ì¸ í›„ ì‚¬ìš©ì ë° í–‰ì‚¬ í”„ë¡œí•„ ë¡œë“œ (await ì¶”ê°€)

                        // í•„ìˆ˜ ì •ë³´ê°€ ì„¤ì •ë˜ì—ˆëŠ”ì§€ í™•ì¸ í›„ ë©”ì¸ ì½˜í…ì¸  í‘œì‹œ ë˜ëŠ” ì„¤ì • ëª¨ë‹¬ í‘œì‹œ
                        const profileDocRef = doc(db, `artifacts/${appId}/users/${currentUserId}/profile/metadata`);
                        const docSnap = await getDoc(profileDocRef);
                        const data = docSnap.exists() ? docSnap.data() : {};

                        // ë‹´ë‹¹ì ì´ë¦„, í–‰ì‚¬ëª…, ë‚ ì§œ ì¤‘ í•˜ë‚˜ë¼ë„ ì—†ìœ¼ë©´ ì„¤ì • ëª¨ë‹¬ í‘œì‹œ
                        if (!data.managerName || !data.eventName || !data.eventDate) {
                            showUserInfoSetupModal();
                        } else {
                            hideUserInfoSetupModal(); // ì´ë¯¸ ì„¤ì •ë˜ì–´ ìˆìœ¼ë©´ ë°”ë¡œ ë©”ì¸ ì½˜í…ì¸  í‘œì‹œ
                        }

                        loadRawData(); // Rawdataë¥¼ ë©”ëª¨ë¦¬ì— ë¡œë“œ
                        loadCheckedInVisitors();
                    } else {
                        console.log("No user signed in. Attempting sign-in...");
                        try {
                            if (initialAuthToken) {
                                await signInWithCustomToken(auth, initialAuthToken);
                                console.log("Signed in with custom token.");
                            } else {
                                await signInAnonymously(auth);
                                console.log("Signed in anonymously.");
                            }
                        } catch (error) {
                            console.error("Firebase authentication error:", error);
                            showMessage(`ì¸ì¦ ì˜¤ë¥˜: ${error.message}`, 'error');
                            displayedUserId.textContent = `ì¸ì¦ ì‹¤íŒ¨`; // í†µí•©ëœ í‘œì‹œì— ì‚¬ìš©ì ID ì—…ë°ì´íŠ¸
                            // ì¸ì¦ ì‹¤íŒ¨ ì‹œì—ë„ ì„¤ì • ëª¨ë‹¬ì„ ë„ìš¸ì§€ ê²°ì • (ì—¬ê¸°ì„œëŠ” ì¼ë‹¨ ìˆ¨ê¹€)
                            // showUserInfoSetupModal(); // í•„ìš”í•˜ë‹¤ë©´ ì¸ì¦ ì‹¤íŒ¨ ì‹œì—ë„ ì„¤ì • ê°•ì œ
                        }
                    }
                });
            } catch (error) {
                console.error("Firebase initialization failed:", error);
                showMessage(`Firebase ì´ˆê¸°í™” ì‹¤íŒ¨: ${error.message}`, 'error');
            }
        }

        // --- ì‚¬ìš©ì ë° í–‰ì‚¬ ì •ë³´ ê´€ë¦¬ í•¨ìˆ˜ ---

        // ì‚¬ìš©ì ë° í–‰ì‚¬ í”„ë¡œí•„ ë¡œë“œ í•¨ìˆ˜
        async function loadUserProfile() {
            if (!db || !currentUserId || currentUserId === 'loading...') {
                console.warn("Firestore ë˜ëŠ” ì‚¬ìš©ì IDê°€ ì¤€ë¹„ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. ì‚¬ìš©ì í”„ë¡œí•„ ë¡œë“œë¥¼ ê±´ë„ˆëœë‹ˆë‹¤.");
                return;
            }
            try {
                // ì‚¬ìš©ìì˜ í”„ë¡œí•„ ì •ë³´ëŠ” users/{uid}/profile/metadata ë¬¸ì„œì— ì €ì¥
                const profileDocRef = doc(db, `artifacts/${appId}/users/${currentUserId}/profile/metadata`);
                const docSnap = await getDoc(profileDocRef);

                let data = {};
                if (docSnap.exists()) {
                    data = docSnap.data();
                }

                // ì„¤ì • ëª¨ë‹¬ ì…ë ¥ í•„ë“œ ì—…ë°ì´íŠ¸
                setupManagerNameInput.value = data.managerName ?? '';
                setupManagerAffiliationInput.value = data.managerAffiliation ?? '';
                setupEventDateInput.value = data.eventDate ?? '';
                setupEventLocationInput.value = data.eventLocation ?? '';
                setupEventNameInput.value = data.eventName ?? '';

                // í‘œì‹œ ì˜ì—­ ì—…ë°ì´íŠ¸
                const managerName = data.managerName ?? 'ì„¤ì •ë˜ì§€ ì•ŠìŒ';
                const managerAffiliation = data.managerAffiliation ?? '';
                const eventDate = data.eventDate ?? 'ì„¤ì •ë˜ì§€ ì•ŠìŒ';
                const eventLocation = data.eventLocation ?? '';
                const eventName = data.eventName ?? 'ì„¤ì •ë˜ì§€ ì•ŠìŒ';

                // ìš”ì²­ëœ í˜•ì‹ê³¼ ìˆœì„œëŒ€ë¡œ í‘œì‹œ
                displayedManagerInfo.textContent = `${managerName}${managerAffiliation ? ' / ' + managerAffiliation : ''}`;
                displayedDateTime.textContent = `${eventDate}${eventLocation ? ' / ' + eventLocation : ''}`;
                displayedEventName.textContent = eventName;

                console.log("User profile loaded:", data);
            } catch (e) {
                console.error("Error loading user profile: ", e);
                showMessage(`ì‚¬ìš©ì ì •ë³´ ë¡œë“œ ì¤‘ ì˜¤ë¥˜ ë°œìƒ: ${e.message}`, 'error');
            }
        }

        // ì‚¬ìš©ì ë° í–‰ì‚¬ ì •ë³´ ì €ì¥ í•¨ìˆ˜ (ì„¤ì • ëª¨ë‹¬ìš©)
        async function saveUserProfileFromSetup() {
            const nameToSave = setupManagerNameInput.value.trim();
            const affiliationToSave = setupManagerAffiliationInput.value.trim();
            const dateToSave = setupEventDateInput.value.trim(); // YYYY-MM-DD í˜•ì‹
            const locationToSave = setupEventLocationInput.value.trim();
            const eventToSave = setupEventNameInput.value.trim();

            // í•„ìˆ˜ ì •ë³´ í™•ì¸: ë‹´ë‹¹ì ì´ë¦„, í–‰ì‚¬ ë‚ ì§œ, í–‰ì‚¬ëª…
            if (!nameToSave || !dateToSave || !eventToSave) {
                showWarningModalMessage('ë‹´ë‹¹ì ì´ë¦„, í–‰ì‚¬ ë‚ ì§œ, í–‰ì‚¬ëª…ì€ í•„ìˆ˜ ì…ë ¥ ì •ë³´ì…ë‹ˆë‹¤.'); // íŒì—… ë©”ì‹œì§€ í‘œì‹œ
                return; // í•¨ìˆ˜ ì‹¤í–‰ ì¤‘ë‹¨
            }
            if (!currentUserId || currentUserId === 'loading...') {
                showMessage('ì‚¬ìš©ì ì¸ì¦ ëŒ€ê¸° ì¤‘ì…ë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.', 'error');
                return;
            }

            try {
                const profileDocRef = doc(db, `artifacts/${appId}/users/${currentUserId}/profile/metadata`);
                await setDoc(profileDocRef, {
                    managerName: nameToSave,
                    managerAffiliation: affiliationToSave,
                    eventDate: dateToSave,
                    eventLocation: locationToSave,
                    eventName: eventToSave
                }, { merge: true });

                // ì €ì¥ í›„ í‘œì‹œ ì˜ì—­ ì¦‰ì‹œ ì—…ë°ì´íŠ¸
                displayedManagerInfo.textContent = `${nameToSave}${affiliationToSave ? ' / ' + affiliationToSave : ''}`;
                displayedDateTime.textContent = `${dateToSave}${locationToSave ? ' / ' + locationToSave : ''}`;
                displayedEventName.textContent = eventToSave;

                showMessage('ì‚¬ìš©ì ë° í–‰ì‚¬ ì •ë³´ê°€ ì„±ê³µì ìœ¼ë¡œ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤!', 'success');
                hideUserInfoSetupModal(); // ì •ë³´ ì €ì¥ ì„±ê³µ ì‹œ ëª¨ë‹¬ ìˆ¨ê¸°ê³  ë©”ì¸ ì½˜í…ì¸  í‘œì‹œ
            } catch (e) {
                console.error("Error saving user profile: ", e);
                showMessage(`ì‚¬ìš©ì ì •ë³´ ì €ì¥ ì¤‘ ì˜¤ë¥˜ ë°œìƒ: ${e.message}`, 'error');
            }
        }

        // --- Rawdata (ë°©ë¬¸ ì˜ˆì •ì) CSV ì—…ë¡œë“œ ë° ê´€ë¦¬ ---

        // CSV íŒŒì¼ ì—…ë¡œë“œ í•¨ìˆ˜
        async function uploadCsvFile() {
            const file = csvFileInput.files[0];
            if (!file) {
                showMessage('ì—…ë¡œë“œí•  CSV íŒŒì¼ì„ ì„ íƒí•´ì£¼ì„¸ìš”.', 'error');
                return;
            }

            if (!currentUserId || currentUserId === 'loading...') {
                showMessage('ì‚¬ìš©ì ì¸ì¦ ëŒ€ê¸° ì¤‘ì…ë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.', 'error');
                return;
            }

            const reader = new FileReader();
            reader.onload = async (e) => {
                const text = e.target.result;
                const lines = text.split('\n').filter(line => line.trim() !== ''); // ë¹ˆ ì¤„ ì œê±°
                const parsedData = [];

                if (lines.length === 0) {
                    showMessage('CSV íŒŒì¼ì— ë‚´ìš©ì´ ì—†ìŠµë‹ˆë‹¤.', 'error');
                    return;
                }

                // ì²« ë²ˆì§¸ ì¤„ì€ í—¤ë”ë¡œ ê°„ì£¼í•˜ê³  ê±´ë„ˆë›°ê¸°
                const header = lines[0].split(',').map(h => h.trim());
                if (header.length !== 5 || header[0] !== 'ì´ë¦„' || header[1] !== 'ì†Œì†' || header[2] !== 'ì§ê¸‰' || header[3] !== 'ì´ë©”ì¼' || header[4] !== 'ì—°ë½ì²˜') {
                    showMessage('CSV í—¤ë” í˜•ì‹ì´ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤. "ì´ë¦„,ì†Œì†,ì§ê¸‰,ì´ë©”ì¼,ì—°ë½ì²˜" í˜•ì‹ì´ì–´ì•¼ í•©ë‹ˆë‹¤.', 'error');
                    return;
                }

                for (let i = 1; i < lines.length; i++) { // ë‘ ë²ˆì§¸ ì¤„ë¶€í„° ë°ì´í„° íŒŒì‹± ì‹œì‘
                    const line = lines[i];
                    const parts = line.split(',').map(p => p.trim()); // ì‰¼í‘œë¡œ êµ¬ë¶„

                    if (parts.length === 5) { // ì´ë¦„,ì†Œì†,ì§ê¸‰,ì´ë©”ì¼,ì—°ë½ì²˜ 5ê°€ì§€ ì •ë³´ í™•ì¸
                        parsedData.push({
                            name: parts[0] || '',
                            affiliation: parts[1] || '',
                            position: parts[2] || '',
                            email: parts[3] || '',
                            contact: parts[4] || '',
                            is_checked_in: false // CSV ì—…ë¡œë“œ ì‹œ ì´ˆê¸°í™” (ì¶œì„ ìƒíƒœëŠ” ë³„ë„ë¡œ ê´€ë¦¬)
                        });
                    } else {
                        showMessage(`ì˜ëª»ëœ í˜•ì‹ì˜ ì¤„ì´ ìˆìŠµë‹ˆë‹¤ (ì¤„ ${i + 1}): ${line}. 'ì´ë¦„,ì†Œì†,ì§ê¸‰,ì´ë©”ì¼,ì—°ë½ì²˜' í˜•ì‹ì´ì–´ì•¼ í•©ë‹ˆë‹¤.`, 'error');
                        return; // í˜•ì‹ ì˜¤ë¥˜ ì‹œ ì¤‘ë‹¨
                    }
                }

                try {
                    // RawdataëŠ” ì‚¬ìš©ìë³„ë¡œ ì €ì¥ë˜ë©°, í•˜ë‚˜ì˜ ë¬¸ì„œì— ëª¨ë“  ì˜ˆì •ì ì •ë³´ë¥¼ ë°°ì—´ë¡œ ì €ì¥
                    // ìƒˆ CSV ì—…ë¡œë“œ ì‹œ ê¸°ì¡´ ë°ì´í„° ë®ì–´ì“°ê¸°
                    const rawDataDocRef = doc(db, `artifacts/${appId}/users/${currentUserId}/config/rawData`);
                    await setDoc(rawDataDocRef, { visitors: parsedData });
                    showMessage('CSV íŒŒì¼ì´ ì„±ê³µì ìœ¼ë¡œ ì—…ë¡œë“œ ë° ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤!', 'success');
                    rawData = parsedData; // ë©”ëª¨ë¦¬ì—ë„ ì—…ë°ì´íŠ¸
                    updateExpectedVisitorCount(); // ì´ ë°©ë¬¸ ì˜ˆì •ì ìˆ˜ ì—…ë°ì´íŠ¸
                    csvFileInput.value = ''; // íŒŒì¼ ì…ë ¥ í•„ë“œ ì´ˆê¸°í™”
                } catch (e) {
                    console.error("Error saving raw data from CSV: ", e);
                    showMessage(`CSV Rawdata ì €ì¥ ì¤‘ ì˜¤ë¥˜ ë°œìƒ: ${e.message}`, 'error');
                }
            };
            reader.onerror = (e) => {
                showMessage(`íŒŒì¼ ì½ê¸° ì˜¤ë¥˜: ${e.message}`, 'error');
                console.error("File reading error:", e);
            };
            reader.readAsText(file); // íŒŒì¼ì„ í…ìŠ¤íŠ¸ë¡œ ì½ê¸°
        }

        // Rawdata ë¡œë“œ í•¨ìˆ˜ (ì•± ì‹œì‘ ì‹œ ë©”ëª¨ë¦¬ì— ë¡œë“œ)
        async function loadRawData() {
            if (!db || !currentUserId || currentUserId === 'loading...') {
                console.warn("Firestore ë˜ëŠ” ì‚¬ìš©ì IDê°€ ì¤€ë¹„ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. Rawdata ë¡œë“œë¥¼ ê±´ë„ˆëœë‹ˆë‹¤.");
                return;
            }
            try {
                const rawDataDocRef = doc(db, `artifacts/${appId}/users/${currentUserId}/config/rawData`);
                const docSnap = await getDoc(rawDataDocRef);

                if (docSnap.exists()) {
                    rawData = docSnap.data().visitors || [];
                    console.log("Rawdata loaded successfully from Firestore.");
                } else {
                    console.log("No raw data found for this user. Starting with empty list.");
                    rawData = [];
                }
                updateExpectedVisitorCount(); // ì´ ë°©ë¬¸ ì˜ˆì •ì ìˆ˜ ì—…ë°ì´íŠ¸
            } catch (e) {
                console.error("Error loading raw data: ", e);
                showMessage(`Rawdata ë¡œë“œ ì¤‘ ì˜¤ë¥˜ ë°œìƒ: ${e.message}`, 'error');
            }
        }

        // ì´ ë°©ë¬¸ ì˜ˆì •ì ìˆ˜ ì—…ë°ì´íŠ¸
        function updateExpectedVisitorCount() {
            totalExpectedVisitorsSpan.textContent = rawData.length;
            rawDataCount.textContent = `í˜„ì¬ ë“±ë¡ëœ ì˜ˆì •ì: ${rawData.length}ëª…`;
        }

        // --- ë°©ë¬¸ì ì¶œì„ í™•ì¸ ë¡œì§ ---

        // ë°©ë¬¸ì ê²€ìƒ‰ ë° í‘œì‹œ
        function searchVisitor() {
            const searchName = visitorNameInput.value.trim().toLowerCase();
            searchResults.innerHTML = ''; // ê²€ìƒ‰ ê²°ê³¼ ì´ˆê¸°í™”

            if (!searchName) {
                showMessage('ë°©ë¬¸ì ì´ë¦„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.', 'info');
                return;
            }

            if (rawData.length === 0) {
                showMessage('ë“±ë¡ëœ ë°©ë¬¸ ì˜ˆì •ì Rawdataê°€ ì—†ìŠµë‹ˆë‹¤. ë¨¼ì € CSV íŒŒì¼ì„ ì—…ë¡œë“œí•´ì£¼ì„¸ìš”.', 'error');
                return;
            }

            // ê²€ìƒ‰ì–´ì— 'í¬í•¨'ë˜ëŠ” ì´ë¦„ìœ¼ë¡œ ê²€ìƒ‰ (ëŒ€ì†Œë¬¸ì êµ¬ë¶„ ì—†ìŒ)
            const matchedVisitors = rawData.filter(visitor =>
                visitor.name.toLowerCase().includes(searchName)
            );

            if (matchedVisitors.length === 0) {
                // ì´ë¦„ì´ ë™ì¼í•œ ì‚¬ëŒì´ ì—†ëŠ” ê²½ìš°
                searchResults.innerHTML = `
                    <p class="search-results-title">ê²€ìƒ‰ ê²°ê³¼: "${searchName}" ì´ë¦„ì˜ ì˜ˆì •ìê°€ ì—†ìŠµë‹ˆë‹¤.</p>
                    <div class="visitor-item">
                        <p class="text-lg font-medium text-red-700">ì¼ì¹˜í•˜ëŠ” ë°©ë¬¸ìê°€ ì—†ìŠµë‹ˆë‹¤.</p>
                        <p class="text-sm text-gray-600">ì´ë¦„: ${searchName}ìœ¼ë¡œ ìƒˆë¡œìš´ ë°©ë¬¸ìë¥¼ ë“±ë¡í•˜ì‹œê² ìŠµë‹ˆê¹Œ?</p>
                        <button class="match-action-btn" onclick="checkInNewVisitor('${searchName.replace(/'/g, "\\'")}')">ìƒˆ ë°©ë¬¸ì ì¶œì„ ì²˜ë¦¬</button>
                    </div>
                `;
            } else {
                // ì´ë¦„ì´ ë™ì¼í•œ ì‚¬ëŒì´ ìˆëŠ” ê²½ìš° (ëª¨ë‘ í‘œì‹œ)
                searchResults.innerHTML = `<p class="search-results-title">"${searchName}" ê²€ìƒ‰ ê²°ê³¼ (${matchedVisitors.length}ëª…):</p>`;
                matchedVisitors.forEach((visitor, index) => {
                    const visitorItem = document.createElement('div');
                    visitorItem.classList.add('visitor-item');

                    visitorItem.innerHTML = `
                        <p class="text-lg font-medium text-gray-900">${visitor.name}</p>
                        <p class="text-sm text-gray-600">ì†Œì†: ${visitor.affiliation || '-'}</p>
                        <p class="text-sm text-gray-600">ì§ê¸‰: ${visitor.position || '-'}</p>
                        <p class="text-sm text-gray-600">ì´ë©”ì¼: ${visitor.email || '-'}</p>
                        <p class="text-sm text-gray-600">ì—°ë½ì²˜: ${visitor.contact || '-'}</p>
                        <button class="match-action-btn" onclick="checkInVisitor(
                            '${visitor.name.replace(/'/g, "\\'")}',
                            '${visitor.affiliation.replace(/'/g, "\\'")}',
                            '${visitor.position.replace(/'/g, "\\'")}',
                            '${visitor.email.replace(/'/g, "\\'")}',
                            '${visitor.contact.replace(/'/g, "\\'")}'
                        )">ì¶œì„ ì²˜ë¦¬</button>
                    `;
                    searchResults.appendChild(visitorItem);
                });
            }
        }

        // ì„ íƒëœ ë°©ë¬¸ìë¥¼ ì¶œì„ ì²˜ë¦¬ (ê¸°ì¡´ ì˜ˆì •ì)
        // ì „ì—­ í•¨ìˆ˜ë¡œ ë…¸ì¶œ
        window.checkInVisitor = async function(name, affiliation, position, email, contact) {
            if (!currentUserId || currentUserId === 'loading...') {
                showMessage('ì‚¬ìš©ì ì¸ì¦ ëŒ€ê¸° ì¤‘ì…ë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.', 'error');
                return;
            }

            try {
                const checkedInVisitorsRef = collection(db, `artifacts/${appId}/users/${currentUserId}/checkedInVisitors`);

                // ì¤‘ë³µ í™•ì¸: ì´ë¦„ê³¼ ì´ë©”ì¼ë¡œ ê²€ìƒ‰. ì´ë©”ì¼ì´ ì—†ëŠ” ê²½ìš° ì´ë¦„ê³¼ ì—°ë½ì²˜ë¡œ ê²€ìƒ‰.
                let q;
                if (email && email !== '' && email !== '-') { // ì´ë©”ì¼ì´ ìœ íš¨í•œ ê²½ìš°
                    q = query(checkedInVisitorsRef,
                        where("name", "==", name),
                        where("email", "==", email)
                    );
                } else if (contact && contact !== '' && contact !== '-') { // ì´ë©”ì¼ì´ ì—†ê³  ì—°ë½ì²˜ê°€ ìœ íš¨í•œ ê²½ìš°
                    q = query(checkedInVisitorsRef,
                        where("name", "==", name),
                        where("contact", "==", contact)
                    );
                } else { // ì´ë©”ì¼ê³¼ ì—°ë½ì²˜ ëª¨ë‘ ì—†ëŠ” ê²½ìš° (ì´ë¦„ìœ¼ë¡œë§Œ ì¤‘ë³µ í™•ì¸, ì •í™•ë„ ë‚®ìŒ)
                    q = query(checkedInVisitorsRef,
                        where("name", "==", name)
                    );
                }

                const querySnapshot = await getDocs(q);
                if (!querySnapshot.empty) {
                    showWarningModalMessage('ì´ë¯¸ ë“±ë¡ëœ ë°©ë¬¸ìì…ë‹ˆë‹¤!'); // íŒì—… ë©”ì‹œì§€ í‘œì‹œ
                    return; // í•¨ìˆ˜ ì‹¤í–‰ ì¤‘ë‹¨
                }

                // ì¤‘ë³µì´ ì•„ë‹ˆë©´ ì¶œì„ ì™„ë£Œ ê¸°ë¡ ì¶”ê°€
                await addDoc(checkedInVisitorsRef, {
                    name: name,
                    affiliation: affiliation,
                    position: position,
                    email: email,
                    contact: contact,
                    checked_in_at: serverTimestamp() // Firebase ì„œë²„ ì‹œê°„ ì‚¬ìš©
                });

                showMessage(`${name}ë‹˜ì˜ ì¶œì„ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!`, 'success');
                visitorNameInput.value = ''; // ì…ë ¥ í•„ë“œ ì´ˆê¸°í™”
                searchResults.innerHTML = ''; // ê²€ìƒ‰ ê²°ê³¼ ì´ˆê¸°í™”
            } catch (e) {
                console.error("Error checking in visitor: ", e);
                showMessage(`ì¶œì„ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ ë°œìƒ: ${e.message}`, 'error');
            }
        }

        // ìƒˆë¡œìš´ ë°©ë¬¸ì ì¶œì„ ì²˜ë¦¬
        // ì „ì—­ í•¨ìˆ˜ë¡œ ë…¸ì¶œ
        window.checkInNewVisitor = async function(name) {
            if (!currentUserId || currentUserId === 'loading...') {
                showMessage('ì‚¬ìš©ì ì¸ì¦ ëŒ€ê¸° ì¤‘ì…ë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.', 'error');
                return;
            }

            try {
                const checkedInVisitorsRef = collection(db, `artifacts/${appId}/users/${currentUserId}/checkedInVisitors`);

                // ìƒˆë¡œìš´ ë°©ë¬¸ìëŠ” ì´ë¦„ìœ¼ë¡œë§Œ ì¤‘ë³µ í™•ì¸
                const q = query(checkedInVisitorsRef,
                    where("name", "==", name)
                );
                const querySnapshot = await getDocs(q);
                if (!querySnapshot.empty) {
                    showWarningModalMessage('ì´ë¯¸ ë“±ë¡ëœ ë°©ë¬¸ìì…ë‹ˆë‹¤!'); // íŒì—… ë©”ì‹œì§€ í‘œì‹œ
                    return; // í•¨ìˆ˜ ì‹¤í–‰ ì¤‘ë‹¨
                }

                await addDoc(checkedInVisitorsRef, {
                    name: name,
                    affiliation: 'ë¯¸ë“±ë¡', // ìƒˆ ë°©ë¬¸ìëŠ” ì •ë³´ê°€ ì—†ìœ¼ë¯€ë¡œ 'ë¯¸ë“±ë¡'
                    position: 'ë¯¸ë“±ë¡',
                    email: 'ë¯¸ë“±ë¡',
                    contact: 'ë¯¸ë“±ë¡',
                    checked_in_at: serverTimestamp()
                });
                showMessage(`ìƒˆ ë°©ë¬¸ì (${name})ì˜ ì¶œì„ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!`, 'success');
                visitorNameInput.value = ''; // ì…ë ¥ í•„ë“œ ì´ˆê¸°í™”
                searchResults.innerHTML = ''; // ê²€ìƒ‰ ê²°ê³¼ ì´ˆê¸°í™”
            } catch (e) {
                console.error("Error checking in new visitor: ", e);
                showMessage(`ìƒˆ ë°©ë¬¸ì ì¶œì„ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ ë°œìƒ: ${e.message}`, 'error');
            }
        }

        // --- ì¶œì„ ì™„ë£Œ ë°©ë¬¸ì ëª©ë¡ ë° ì§‘ê³„ ---

        // ì¶œì„ ì™„ë£Œ ë°©ë¬¸ì ì‹¤ì‹œê°„ ë¡œë“œ ë° ì§‘ê³„
        function loadCheckedInVisitors() {
            if (!db || !currentUserId || currentUserId === 'loading...') {
                console.warn("Firestore ë˜ëŠ” ì‚¬ìš©ì IDê°€ ì¤€ë¹„ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. ì¶œì„ ì™„ë£Œ ë°©ë¬¸ì ë¡œë“œë¥¼ ê±´ë„ˆëœë‹ˆë‹¤.");
                return;
            }

            const checkedInVisitorsRef = collection(db, `artifacts/${appId}/users/${currentUserId}/checkedInVisitors`);
            // ìµœì‹  ì¶œì„ ê¸°ë¡ì´ ìœ„ì— ì˜¤ë„ë¡ ì •ë ¬
            const q = query(checkedInVisitorsRef, orderBy('checked_in_at', 'desc'));

            onSnapshot(q, (snapshot) => {
                checkedInList.innerHTML = ''; // ëª©ë¡ ì´ˆê¸°í™”
                let checkedInCount = 0;
                // í˜„ì¬ ì¶œì„ ì™„ë£Œëœ ë°©ë¬¸ì ì´ë¦„ì„ ë¹ ë¥´ê²Œ ì°¾ê¸° ìœ„í•œ Set
                const currentlyCheckedInNames = new Set();

                snapshot.forEach((doc) => {
                    const visitor = doc.data();
                    checkedInCount++;
                    const checkedInItem = document.createElement('div');
                    checkedInItem.classList.add('checked-in-item');
                    const checkedInTime = visitor.checked_in_at ? visitor.checked_in_at.toDate().toLocaleString('ko-KR') : 'ì‹œê°„ ì •ë³´ ì—†ìŒ'; // í•œêµ­ ì‹œê°„ í¬ë§·
                    checkedInItem.innerHTML = `
                        <p class="text-lg font-medium text-gray-900">${visitor.name}</p>
                        <p class="text-sm text-gray-600">ì†Œì†: ${visitor.affiliation || '-'}</p>
                        <p class="text-sm text-gray-600">ì§ê¸‰: ${visitor.position || '-'}</p>
                        <p class="text-sm text-gray-600">ì´ë©”ì¼: ${visitor.email || '-'}</p>
                        <p class="text-sm text-gray-600">ì—°ë½ì²˜: ${visitor.contact || '-'}</p>
                        <p class="text-sm text-gray-600">ì¶œì„ ì‹œê°„: ${checkedInTime}</p>
                    `;
                    checkedInList.appendChild(checkedInItem);

                    currentlyCheckedInNames.add(visitor.name.toLowerCase()); // ì¤‘ë³µ ì¶œì„ ë°©ì§€ë¥¼ ìœ„í•´ ì´ë¦„ ì €ì¥
                });
                currentCheckedInSpan.textContent = checkedInCount; // í˜„ì¬ ë°©ë¬¸ì ìˆ˜ ì—…ë°ì´íŠ¸
                if (checkedInCount === 0) {
                    checkedInList.innerHTML = '<p class="text-gray-500 text-center">ì•„ì§ ì¶œì„ ì™„ë£Œëœ ë°©ë¬¸ìê°€ ì—†ìŠµë‹ˆë‹¤.</p>';
                }

                // ë§¤ì¹­ ê²°ê³¼ í‘œì‹œ ì—…ë°ì´íŠ¸ (ì´ë¯¸ ì¶œì„í•œ ì‚¬ëŒ í‘œì‹œ)
                const searchName = visitorNameInput.value.trim().toLowerCase();
                if (searchName) {
                    const currentSearchResults = searchResults.innerHTML;
                    if (currentSearchResults) {
                        const tempDiv = document.createElement('div');
                        tempDiv.innerHTML = currentSearchResults;
                        const visitorItems = tempDiv.querySelectorAll('.visitor-item');
                        visitorItems.forEach(item => {
                            const nameElement = item.querySelector('p.text-lg.font-medium');
                            if (nameElement) {
                                const visitorName = nameElement.textContent.trim().toLowerCase();
                                const button = item.querySelector('button.match-action-btn');
                                const existingMessage = item.querySelector('p.text-md.font-bold');

                                if (currentlyCheckedInNames.has(visitorName)) {
                                    if (button) button.remove();
                                    if (!existingMessage) {
                                        const p = document.createElement('p');
                                        p.classList.add('text-md', 'font-bold', 'text-green-600', 'mt-2');
                                        p.textContent = 'âœ… ì´ë¯¸ ì¶œì„ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.';
                                        item.appendChild(p);
                                    }
                                } else {
                                     if (existingMessage) existingMessage.remove();
                                     if (!button && nameElement.textContent.trim() !== 'ì¼ì¹˜í•˜ëŠ” ë°©ë¬¸ìê°€ ì—†ìŠµë‹ˆë‹¤.') {
                                        const visitorData = rawData.find(v => v.name.toLowerCase() === visitorName);
                                        if (visitorData) {
                                            const newButton = document.createElement('button');
                                            newButton.classList.add('match-action-btn');
                                            newButton.textContent = 'ì¶œì„ ì²˜ë¦¬';
                                            newButton.onclick = () => window.checkInVisitor(
                                                visitorData.name,
                                                visitorData.affiliation,
                                                visitorData.position,
                                                visitorData.email,
                                                visitorData.contact
                                            );
                                            item.appendChild(newButton);
                                        }
                                     }
                                }
                            }
                        });
                        searchResults.innerHTML = tempDiv.innerHTML;
                    }
                }
            }, (error) => {
                console.error("Error fetching checked-in visitors: ", error);
                showMessage(`ì¶œì„ ì™„ë£Œ ë°©ë¬¸ì ë¡œë“œ ì¤‘ ì˜¤ë¥˜ ë°œìƒ: ${error.message}`, 'error');
            });
        }

        // --- ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì„¤ì • ---

        uploadCsvBtn.addEventListener('click', uploadCsvFile);
        searchVisitorBtn.addEventListener('click', searchVisitor);
        visitorNameInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                searchVisitor();
            }
        });

        // ì‚¬ìš©ì ë° í–‰ì‚¬ ì •ë³´ ì €ì¥ ë²„íŠ¼ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ (ìƒˆë¡œìš´ ë²„íŠ¼)
        setupSaveUserInfoBtn.addEventListener('click', saveUserProfileFromSetup);

        // ê²½ê³  ëª¨ë‹¬ ë‹«ê¸° ë²„íŠ¼ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
        modalCloseBtn.addEventListener('click', hideWarningModalMessage);
        // ê²½ê³  ëª¨ë‹¬ ì˜¤ë²„ë ˆì´ í´ë¦­ ì‹œ ë‹«ê¸° (ì„ íƒ ì‚¬í•­)
        warningModal.addEventListener('click', (e) => {
            if (e.target === warningModal) {
                hideWarningModalMessage();
            }
        });

        // --- ì•± ì‹œì‘ ---
        initializeFirebase();
    </script>
</body>
</html>
